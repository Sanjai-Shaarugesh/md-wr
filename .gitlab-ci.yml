stages:
  - build
  - test

variables:
  CARGO_TERM_COLOR: always

before_script:
  # ðŸ§© Detect package manager and install system dependencies (including blueprint-compiler)
  - |
    if command -v apt-get >/dev/null; then
      echo "Using apt-get..."
      apt-get update -y
      apt-get install -y build-essential pkg-config libgtk-4-dev libadwaita-1-dev libglib2.0-dev meson ninja-build python3-pip curl
      pip install --break-system-packages blueprint-compiler
    elif command -v dnf >/dev/null; then
      echo "Using dnf..."
      dnf install -y gtk4-devel libadwaita-devel glib2-devel meson ninja-build python3-pip gcc make pkgconf-pkg-config curl
      pip install blueprint-compiler
    elif command -v pacman >/dev/null; then
      echo "Using pacman..."
      pacman -Sy --noconfirm base-devel gtk4 libadwaita glib2 meson python-pip pkgconf curl
      pip install blueprint-compiler
    elif command -v apk >/dev/null; then
      echo "Using apk..."
      apk add --no-cache build-base gtk4.0-dev libadwaita-dev glib-dev meson py3-pip pkgconfig curl
      pip install blueprint-compiler
    else
      echo "âš ï¸ No supported package manager found!"
      exit 1
    fi

  # ðŸ¦€ Install Rust and Just if missing
  - if ! command -v cargo >/dev/null; then curl https://sh.rustup.rs -sSf | sh -s -- -y; fi
  - export PATH="$HOME/.cargo/bin:$PATH"
  - rustup default stable
  - cargo install just || true

build:
  stage: build
  script:
    - just build
  artifacts:
    paths:
      - target/release/
      - build/schemas/
      - src/data/ui/*.ui
      - resources.gresource
    expire_in: 1 week

test:
  stage: test
  script:
    - just test
